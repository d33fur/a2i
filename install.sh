#!/bin/bash

A2I_DIR=a2i
CLI_DIR=cli
MAN_DIR=/usr/local/share/man/man1
BIN_DIR=/usr/local/bin

GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

lines1='________________________________________________________        \n ________________________________________________________       \n  ________________________________________________________      \n   ________________________________________________________     \n    ________________________________________________________    \n     ________________________________________________________   \n      ________________________________________________________  \n       ________________________________________________________ \n        ________________________________________________________\n'
lines2='__/\\\\___________________________________________________        \n _\\/\\\\___________________________________________________       \n  _\\/\\\\___________________________________________________      \n   _\\/\\\\___________________________________________________     \n    _\\/\\\\___________________________________________________    \n     _\\/\\\\___________________________________________________   \n      _\\/\\\\___________________________________________________  \n       _\\/\\\\___________________________________________________ \n        _\\//____________________________________________________\n'
lines3='_____/\\\\\\\\\\\\\\\\\\_____/\\\\_________________________________        \n ___/\\\\\\\\\\\\\\\\\\\\\\\\\\__\\/\\\\_________________________________       \n  __/\\\\\\/////////\\\\\\_\\/\\\\_________________________________      \n   _\\/\\\\\\_______\\/\\\\\\_\\/\\\\_________________________________     \n    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_\\/\\\\_________________________________    \n     _\\/\\\\\\/////////\\\\\\_\\/\\\\_________________________________   \n      _\\/\\\\\\_______\\/\\\\\\_\\/\\\\_________________________________  \n       _\\/\\\\\\_______\\/\\\\\\_\\/\\\\_________________________________ \n        _\\///________\\///__\\//__________________________________\n'
lines4='_____/\\\\\\\\\\\\\\\\\\_________________________________________        \n ___/\\\\\\\\\\\\\\\\\\\\\\\\\\_______________________________________       \n  __/\\\\\\/////////\\\\\\______________________________________      \n   _\\/\\\\\\_______\\/\\\\\\______________________________________     \n    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\______________________________________    \n     _\\/\\\\\\/////////\\\\\\______________________________________   \n      _\\/\\\\\\_______\\/\\\\\\______________________________________  \n       _\\/\\\\\\_______\\/\\\\\\______________________________________ \n        _\\///________\\///_______________________________________\n'
lines5='_____/\\\\\\\\\\\\\\\\\\_______/\\\\\\\\\\\\\\\\\\______/\\\\_______________        \n ___/\\\\\\\\\\\\\\\\\\\\\\\\\\___/\\\\\\///////\\\\\\___\\/\\\\_______________       \n  __/\\\\\\/////////\\\\\\_\\///______\\//\\\\\\__\\/\\\\_______________      \n   _\\/\\\\\\_______\\/\\\\\\___________/\\\\\\/___\\/\\\\_______________     \n    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\________/\\\\\\//_____\\/\\\\_______________    \n     _\\/\\\\\\/////////\\\\\\_____/\\\\\\//________\\/\\\\_______________   \n      _\\/\\\\\\_______\\/\\\\\\___/\\\\\\/___________\\/\\\\_______________  \n       _\\/\\\\\\_______\\/\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_\\/\\\\_______________ \n        _\\///________\\///__\\///////////////__\\//________________\n'
lines6='_____/\\\\\\\\\\\\\\\\\\_______/\\\\\\\\\\\\\\\\\\________________________        \n ___/\\\\\\\\\\\\\\\\\\\\\\\\\\___/\\\\\\///////\\\\\\______________________       \n  __/\\\\\\/////////\\\\\\_\\///______\\//\\\\\\_____________________      \n   _\\/\\\\\\_______\\/\\\\\\___________/\\\\\\/______________________     \n    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\________/\\\\\\//________________________    \n     _\\/\\\\\\/////////\\\\\\_____/\\\\\\//___________________________   \n      _\\/\\\\\\_______\\/\\\\\\___/\\\\\\/______________________________  \n       _\\/\\\\\\_______\\/\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\____________________ \n        _\\///________\\///__\\///////////////_____________________\n'
lines7='_____/\\\\\\\\\\\\\\\\\\_______/\\\\\\\\\\\\\\\\\\______/\\\\\\\\\\\\\\\\\\\\\\__/\\\\_        \n ___/\\\\\\\\\\\\\\\\\\\\\\\\\\___/\\\\\\///////\\\\\\___\\/////\\\\\\///__\\/\\\\_       \n  __/\\\\\\/////////\\\\\\_\\///______\\//\\\\\\______\\/\\\\\\_____\\/\\\\_      \n   _\\/\\\\\\_______\\/\\\\\\___________/\\\\\\/_______\\/\\\\\\_____\\/\\\\_     \n    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\________/\\\\\\//_________\\/\\\\\\_____\\/\\\\_    \n     _\\/\\\\\\/////////\\\\\\_____/\\\\\\//____________\\/\\\\\\_____\\/\\\\_   \n      _\\/\\\\\\_______\\/\\\\\\___/\\\\\\/_______________\\/\\\\\\_____\\/\\\\_  \n       _\\/\\\\\\_______\\/\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\_\\/\\\\_ \n        _\\///________\\///__\\///////////////__\\///////////__\\//__\n'
lines8='_____/\\\\\\\\\\\\\\\\\\_______/\\\\\\\\\\\\\\\\\\______/\\\\\\\\\\\\\\\\\\\\\\______        \n ___/\\\\\\\\\\\\\\\\\\\\\\\\\\___/\\\\\\///////\\\\\\___\\/////\\\\\\///_______       \n  __/\\\\\\/////////\\\\\\_\\///______\\//\\\\\\______\\/\\\\\\__________      \n   _\\/\\\\\\_______\\/\\\\\\___________/\\\\\\/_______\\/\\\\\\__________     \n    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\________/\\\\\\//_________\\/\\\\\\__________    \n     _\\/\\\\\\/////////\\\\\\_____/\\\\\\//____________\\/\\\\\\__________   \n      _\\/\\\\\\_______\\/\\\\\\___/\\\\\\/_______________\\/\\\\\\__________  \n       _\\/\\\\\\_______\\/\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\______ \n        _\\///________\\///__\\///////////////__\\///////////_______\n'

log_filename="install.log"

if [ -e "$log_filename" ]; then
    > "$log_filename"
else
    touch "$log_filename"
fi

animate() {
    local lines=("$@")
    while true; do
        for line in "${lines[@]}"; do
            tput rc
            tput cuu 17
            echo -ne "$line"
            sleep 1.0
        done
    done
}

update_output() {
    local line="$1"
    local max_length=$(tput cols)

    echo "$line" >> "$log_filename"

    while [ ${#line} -gt $max_length ]; do
        output+=("${line:0:$max_length}")
        line="${line:$max_length}"
    done
    
    output+=("$line")

    while [ ${#output[@]} -gt 5 ]; do
        output=("${output[@]:1}")
    done

    tput rc
    tput cuu 6
    for ((i = 0; i < 5; i++)); do
        tput el
        [ -n "${output[i]}" ] && echo -e "${output[i]}"
    done
}

build_a2i() {
    tput civis
    echo -e '\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n'
    tput sc
    animate "$lines1" "$lines2" &
    pid=$!
    output=()
    { cmake -B $A2I_DIR/build -S $A2I_DIR; cmake --build $A2I_DIR/build --target install; } 2>&1 | while IFS= read -r line; do
        update_output "$line"
    done
    kill $pid
}

build_cli() {
    animate "$lines3" "$lines4" &
    pid=$!
    output=()
    { cmake -B $CLI_DIR/build -S $CLI_DIR; cmake --build $CLI_DIR/build; } 2>&1 | while IFS= read -r line; do
        update_output "$line"
    done
    kill $pid
}

install_cli() {
    animate "$lines5" "$lines6" &
    pid=$!
    output=()
    { cp $CLI_DIR/build/a2i $BIN_DIR; chmod +x $BIN_DIR/a2i; mkdir -p $MAN_DIR; cp -r man/. $MAN_DIR/; mandb; mkdir -p ~/.a2i; a2i config reset-default; } 2>&1 | while IFS= read -r line; do
        update_output "$line"
    done
    kill $pid
}

clean() {
    animate "$lines7" "$lines8" &
    pid=$!
    output=()
    { rm -rf $A2I_DIR/build $CLI_DIR/build; } 2>&1 | while IFS= read -r line; do
        update_output "$line"
    done
    kill $pid
}

final_message() {
    animate "$lines8" &
    pid=$!
    sleep 0.1
    kill $pid
    update_output "${GREEN}Thank you for using our software!${NC}"
    update_output "${NC}Please visit the following links for more information:"
    update_output "${NC}Documentation: ${GREEN}https://d33fur.github.io/a2i/index.html${NC}"
    update_output "${NC}GitHub: ${GREEN}https://github.com/d33fur/a2i${NC}"
    update_output "${NC}For more information, run: ${GREEN}a2i --help${NC}"
    tput cnorm
}

run_tests() {
    python3 tests/test_cli.py
}

usage() {
    echo "Usage: $0 {build_a2i|build_cli|install_cli|clean|final_message|run_tests|all}"
    exit 1
}

main() {
    case "$1" in
        build_a2i) build_a2i ;;
        build_cli) build_cli ;;
        install_cli) install_cli ;;
        clean) clean ;;
        run_tests) run_tests ;;
        all)
            build_a2i
            build_cli
            install_cli
            clean
            final_message
            ;;
        *) usage ;;
    esac
}

main "$@"