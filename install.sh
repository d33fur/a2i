#!/bin/bash

A2I_DIR=a2i
CLI_DIR=cli
MAN_DIR=/usr/local/share/man/man1
BIN_DIR=/usr/local/bin

GREEN='\033[0;32m'
NC='\033[0m'

lines1=(
    '________________________________________________________        '
    ' ________________________________________________________       '
    '  ________________________________________________________      '
    '   ________________________________________________________     '
    '    ________________________________________________________    '
    '     ________________________________________________________   '
    '      ________________________________________________________  '
    '       ________________________________________________________ '
    '        ________________________________________________________'
)

lines2=(
    '__/\\\\___________________________________________________        '
    ' _\\/\\\\___________________________________________________       '
    '  _\\/\\\\___________________________________________________      '
    '   _\\/\\\\___________________________________________________     '
    '    _\\/\\\\___________________________________________________    '
    '     _\\/\\\\___________________________________________________   '
    '      _\\/\\\\___________________________________________________  '
    '       _\\/\\\\___________________________________________________ '
    '        _\\//____________________________________________________'
)

lines3=(
    '_____/\\\\\\\\\\\\\\\\\\_____/\\\\_________________________________        '
    ' ___/\\\\\\\\\\\\\\\\\\\\\\\\\\__\\/\\\\_________________________________       '
    '  __/\\\\\\/////////\\\\\\_\\/\\\\_________________________________      '
    '   _\\/\\\\\\_______\\/\\\\\\_\\/\\\\_________________________________     '
    '    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_\\/\\\\_________________________________    '
    '     _\\/\\\\\\/////////\\\\\\_\\/\\\\_________________________________   '
    '      _\\/\\\\\\_______\\/\\\\\\_\\/\\\\_________________________________  '
    '       _\\/\\\\\\_______\\/\\\\\\_\\/\\\\_________________________________ '
    '        _\\///________\\///__\\//__________________________________'
)

lines4=(
    '_____/\\\\\\\\\\\\\\\\\\_________________________________________        '
    ' ___/\\\\\\\\\\\\\\\\\\\\\\\\\\_______________________________________       '
    '  __/\\\\\\/////////\\\\\\______________________________________      '
    '   _\\/\\\\\\_______\\/\\\\\\______________________________________     '
    '    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\______________________________________    '
    '     _\\/\\\\\\/////////\\\\\\______________________________________   '
    '      _\\/\\\\\\_______\\/\\\\\\______________________________________  '
    '       _\\/\\\\\\_______\\/\\\\\\______________________________________ '
    '        _\\///________\\///_______________________________________'
)

lines5=(
    '_____/\\\\\\\\\\\\\\\\\\_______/\\\\\\\\\\\\\\\\\\______/\\\\_______________        '
    ' ___/\\\\\\\\\\\\\\\\\\\\\\\\\\___/\\\\\\///////\\\\\\___\\/\\\\_______________       '
    '  __/\\\\\\/////////\\\\\\_\\///______\\//\\\\\\__\\/\\\\_______________      '
    '   _\\/\\\\\\_______\\/\\\\\\___________/\\\\\\/___\\/\\\\_______________     '
    '    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\________/\\\\\\//_____\\/\\\\_______________    '
    '     _\\/\\\\\\/////////\\\\\\_____/\\\\\\//________\\/\\\\_______________   '
    '      _\\/\\\\\\_______\\/\\\\\\___/\\\\\\/___________\\/\\\\_______________  '
    '       _\\/\\\\\\_______\\/\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_\\/\\\\_______________ '
    '        _\\///________\\///__\\///////////////__\\//________________'
)

lines6=(
    '_____/\\\\\\\\\\\\\\\\\\_______/\\\\\\\\\\\\\\\\\\________________________        '
    ' ___/\\\\\\\\\\\\\\\\\\\\\\\\\\___/\\\\\\///////\\\\\\______________________       '
    '  __/\\\\\\/////////\\\\\\_\\///______\\//\\\\\\_____________________      '
    '   _\\/\\\\\\_______\\/\\\\\\___________/\\\\\\/______________________     '
    '    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\________/\\\\\\//________________________    '
    '     _\\/\\\\\\/////////\\\\\\_____/\\\\\\//___________________________   '
    '      _\\/\\\\\\_______\\/\\\\\\___/\\\\\\/______________________________  '
    '       _\\/\\\\\\_______\\/\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\____________________ '
    '        _\\///________\\///__\\///////////////_____________________'
)

lines7=(
    '_____/\\\\\\\\\\\\\\\\\\_______/\\\\\\\\\\\\\\\\\\______/\\\\\\\\\\\\\\\\\\\\\\__/\\\\_        '
    ' ___/\\\\\\\\\\\\\\\\\\\\\\\\\\___/\\\\\\///////\\\\\\___\\/////\\\\\\///__\\/\\\\_       '
    '  __/\\\\\\/////////\\\\\\_\\///______\\//\\\\\\______\\/\\\\\\_____\\/\\\\_      '
    '   _\\/\\\\\\_______\\/\\\\\\___________/\\\\\\/_______\\/\\\\\\_____\\/\\\\_     '
    '    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\________/\\\\\\//_________\\/\\\\\\_____\\/\\\\_    '
    '     _\\/\\\\\\/////////\\\\\\_____/\\\\\\//____________\\/\\\\\\_____\\/\\\\_   '
    '      _\\/\\\\\\_______\\/\\\\\\___/\\\\\\/_______________\\/\\\\\\_____\\/\\\\_  '
    '       _\\/\\\\\\_______\\/\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\_\\/\\\\_ '
    '        _\\///________\\///__\\///////////////__\\///////////__\\//__'
)

lines8=(
    '_____/\\\\\\\\\\\\\\\\\\_______/\\\\\\\\\\\\\\\\\\______/\\\\\\\\\\\\\\\\\\\\\\______        '
    ' ___/\\\\\\\\\\\\\\\\\\\\\\\\\\___/\\\\\\///////\\\\\\___\\/////\\\\\\///_______       '
    '  __/\\\\\\/////////\\\\\\_\\///______\\//\\\\\\______\\/\\\\\\__________      '
    '   _\\/\\\\\\_______\\/\\\\\\___________/\\\\\\/_______\\/\\\\\\__________     '
    '    _\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\________/\\\\\\//_________\\/\\\\\\__________    '
    '     _\\/\\\\\\/////////\\\\\\_____/\\\\\\//____________\\/\\\\\\__________   '
    '      _\\/\\\\\\_______\\/\\\\\\___/\\\\\\/_______________\\/\\\\\\__________  '
    '       _\\/\\\\\\_______\\/\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\__/\\\\\\\\\\\\\\\\\\\\\\______ '
    '        _\\///________\\///__\\///////////////__\\///////////_______'
)

print_lines_with_delay() {
    local -n lines=$1
    for line in "${lines[@]}"; do
        echo -ne "$line\r\n"
    done
    sleep 1.0
}

clear_lines() {
    for ((i = 0; i < 9; i++)); do
        tput cuu1
        tput sc
    done
}

animate() {
    local -n arrays=$1
    while true; do
        for item in "${arrays[@]}"; do
            count=$(eval echo \${#${item}[@]})
            print_lines_with_delay $item
            clear_lines
        done
    done
}

build_a2i() {
    tput civis
    local array=("lines1" "lines2")
    animate array &
    pid=$!
    cmake -B $A2I_DIR/build -S $A2I_DIR > /dev/null
    cmake --build $A2I_DIR/build --target install > /dev/null 2>&1
    kill $pid
    clear_lines array
}

build_cli() {
    local array=("lines3" "lines4")
    animate array &
    pid=$!
    cmake -B $CLI_DIR/build -S $CLI_DIR > /dev/null
    cmake --build $CLI_DIR/build > /dev/null 2>&1
    kill $pid
    clear_lines array
}

install_cli() {
    local array=("lines5" "lines6")
    animate array &
    pid=$!
    cp $CLI_DIR/build/a2i $BIN_DIR
    chmod +x $BIN_DIR/a2i
    mkdir -p $MAN_DIR
    cp -r man/. $MAN_DIR/
    mandb > /dev/null
    mkdir -p ~/.a2i
    a2i config reset-default > /dev/null
    kill $pid
    clear_lines array
}

clean() {
    local array=("lines7" "lines8")
    animate array &
    pid=$!
    rm -rf $A2I_DIR/build $CLI_DIR/build
    kill $pid
    clear_lines array
    local ar=("lines8")
    animate ar &
    pid=$!
    sleep 0.1
    kill $pid
    tput sc
}

final_message() {
    echo -e "\n${GREEN}Thank you for using our software!${NC}"
    echo "Please visit the following links for more information:"
    echo -e "Documentation: ${GREEN}https://d33fur.github.io/a2i/index.html${NC}"
    echo -e "GitHub: ${GREEN}https://github.com/d33fur/a2i${NC}"
    echo -e "For more information, run: ${GREEN}a2i help${NC}"
    tput cnorm
}

run_tests() {
    python3 tests/test_cli.py
}

usage() {
    echo "Usage: $0 {build_a2i|build_cli|install_cli|create_config|clean|final_message|run_tests|all}"
    exit 1
}

main() {
    case "$1" in
        build_a2i) build_a2i ;;
        build_cli) build_cli ;;
        install_cli) install_cli ;;
        clean) clean ;;
        run_tests) run_tests ;;
        all)
            build_a2i
            build_cli
            install_cli
            clean
            final_message
            ;;
        *) usage ;;
    esac
}

main "$@"